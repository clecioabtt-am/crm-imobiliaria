<!doctype html>
<html lang="pt-br"><head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Negócios - CRM</title>
<link rel="stylesheet" href="css/style.css" />
</head>
<body>
<div class="container">
  <div id="nav"></div>

  <div class="card">
    <div class="row">
      <h2>Negócios</h2>
      <span class="small">CRUD básico</span>
    </div>

    <div class="card">
      <h3>Novo</h3>
      <div class="grid">

      <div>
        <label>Contact ID</label>
        <input class="input" id="contact_id" type="number" placeholder="1"/>
      </div>


      <div>
        <label>Property ID (opcional)</label>
        <input class="input" id="property_id" type="number" placeholder="1"/>
      </div>


      <div>
        <label>Etapa</label>
        <input class="input" id="stage" type="text" placeholder="Qualificando"/>
      </div>


      <div>
        <label>Valor</label>
        <input class="input" id="value" type="number" placeholder="0"/>
      </div>


      <div>
        <label>Atribuir User ID (opcional)</label>
        <input class="input" id="assigned_to_user_id" type="number" placeholder=""/>
      </div>

      </div>
      <div style="margin-top:12px" class="row">
        <button class="btn" id="create">Salvar</button>
        <span class="small" id="msg"></span>
      </div>
    </div>

    <table class="table" id="tbl">
      <thead><tr><th>ID</th><th>Resumo</th><th class="small">Ações</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="js/app.js"></script>
<script>
requireAuth();
document.getElementById("nav").innerHTML = navHtml();

async function load(){
  const rows = await api("/api/deals");
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `${r.id}</td><td><b>Contato #${r.contact_id}</b><div class="small">Imóvel #${r.property_id||"-"} • ${r.stage} • Valor: R$ ${Number(r.value).toFixed(2)}</div></td><td>-</td>`;
    tb.appendChild(tr);
  });
}

document.getElementById("create").onclick = async () => {
  const msg = document.getElementById("msg");
  msg.textContent = "Salvando...";
  try {
    const payload = ({
      contact_id: Number(document.getElementById("contact_id").value),
      property_id: document.getElementById("property_id").value ? Number(document.getElementById("property_id").value) : null,
      stage: document.getElementById("stage").value || "Qualificando",
      value: Number(document.getElementById("value").value || 0),
      assigned_to_user_id: document.getElementById("assigned_to_user_id").value ? Number(document.getElementById("assigned_to_user_id").value) : null
    });
    await api("/api/deals","POST", payload);
    msg.textContent = "Salvo!";
    await load();
  } catch(e) {
    msg.textContent = e.message;
  }
};

load();
</script>
</body></html>
